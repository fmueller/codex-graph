FROM apache/age:release_PG16_1.6.0 AS builder

ARG TARGETARCH
ENV PG_MAJOR=16
ENV PG_HOME=/usr/lib/postgresql/${PG_MAJOR}
ENV PG_CONFIG=${PG_HOME}/bin/pg_config
ENV PGVECTOR_VERSION=0.8.1

RUN apt-get update && apt-get install -y --no-install-recommends \
      git build-essential ca-certificates curl \
      postgresql-server-dev-${PG_MAJOR} \
 && rm -rf /var/lib/apt/lists/*

RUN git clone --branch v${PGVECTOR_VERSION} --depth 1 https://github.com/pgvector/pgvector.git /pgvector-src

# Build pgvector with safe CPU flags chosen per target architecture
RUN cd /pgvector-src \
 && case "${TARGETARCH}" in \
      arm64) CFLAGS="-O2 -fno-strict-aliasing -fPIC -fvisibility=hidden -march=armv8-a" ;; \
      amd64) CFLAGS="-O2 -fno-strict-aliasing -fPIC -fvisibility=hidden -march=x86-64 -mtune=generic" ;; \
      *) echo "Unsupported TARGETARCH: ${TARGETARCH}" >&2; exit 1 ;; \
    esac \
 && make PG_CONFIG=${PG_CONFIG} CFLAGS="${CFLAGS}" \
 && make install DESTDIR=/pgvector-build/install PG_CONFIG=${PG_CONFIG}

FROM apache/age:release_PG16_1.6.0

COPY --from=builder /pgvector-build/install/ /

# Initialize AGE and pgvector on first run
RUN mkdir -p /docker-entrypoint-initdb.d
COPY init-extensions.sql /docker-entrypoint-initdb.d/01-init-extensions.sql

EXPOSE 5432
